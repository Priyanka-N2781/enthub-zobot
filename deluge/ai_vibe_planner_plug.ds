// ========================================
// AI VIBE PLANNER PLUG v1.0 (CREATIVE BROWNIE POINTS)
// Entertainment Chatbot for Zoho SalesIQ
// Purpose: AI-powered personalized night plan generator
// Auth: OAuth 2.0 Connection (OpenAI)
// Language: Deluge
// Features: Privacy-preserving mood tagging
// ========================================

pluginResponse = map();
pluginResponse.put("isSuccessful", false);
pluginResponse.put("timestamp", now().toString());

try {
    // ===== INPUT VALIDATION =====
    moodText = plug_input.get("mood_text");
    company = plug_input.get("company"); // solo, partner, friends, family
    duration = plug_input.get("duration"); // short (2-3hrs), medium (4-5hrs), long (6+ hrs)
    
    info "[VibePlanner] Processing - Mood: " + moodText + ", Company: " + company + ", Duration: " + duration;
    
    // Validate inputs
    if(moodText.isEmpty()) {
        pluginResponse.put("message", "Tell me how you're feeling!");
        return pluginResponse;
    }
    
    // ===== PRIVACY-PRESERVING MOOD TAGGING =====
    // Convert raw mood text to safe, predefined tags
    // No raw personal data is stored or sent to AI
    moodTag = tagMood(moodText);
    
    info "[VibePlanner] Privacy-safe mood tag: " + moodTag;
    
    // ===== BUILD AI PROMPT =====
    aiPrompt = buildAIPrompt(moodTag, company, duration);
    
    // ===== INVOKE OPENAI API =====
    openai_url = "https://api.openai.com/v1/chat/completions";
    
    requestBody = map();
    requestBody.put("model", "gpt-3.5-turbo");
    requestBody.put("temperature", 0.7);
    requestBody.put("max_tokens", 500);
    
    messages = list();
    systemMessage = map();
    systemMessage.put("role", "system");
    systemMessage.put("content", "You are an entertainment night planner. Respond ONLY with valid JSON.");
    messages.add(systemMessage);
    
    userMessage = map();
    userMessage.put("role", "user");
    userMessage.put("content", aiPrompt);
    messages.add(userMessage);
    
    requestBody.put("messages", messages);
    
    response = invokeurl([
        url: openai_url,
        type: "POST",
        parameters: requestBody.toString(),
        headers: {"Content-Type": "application/json"},
        connection: "openai_connection"
    ]);
    
    responseMap = response.toMap();
    
    // ===== PROCESS AI RESPONSE =====
    choices = responseMap.get("choices");
    
    if(choices != null && choices.size() > 0) {
        aiContent = choices.get(0).get("message").get("content");
        
        // Parse JSON response from AI
        planData = aiContent.toMap();
        
        // Build response with privacy note
        vibeData = map();
        vibeData.put("plan_type", planData.get("plan_type") != null ? planData.get("plan_type") : "Evening Plan");
        vibeData.put("movie", planData.get("movie"));
        vibeData.put("food", planData.get("food"));
        vibeData.put("activity", planData.get("activity"));
        vibeData.put("reason", planData.get("reason"));
        vibeData.put("timeline", planData.get("timeline"));
        
        // Privacy note - inform user about data handling
        vibeData.put("privacy_note", "Your mood was converted to safe tags. No raw personal data was stored.");
        vibeData.put("mood_tag_used", moodTag);
        
        pluginResponse.put("vibe_plan", vibeData);
        pluginResponse.put("isSuccessful", true);
        pluginResponse.put("message", "Here's your personalized vibe plan!");
    } else {
        // Fallback plan if AI fails
        pluginResponse = generateFallbackPlan(moodTag, company);
    }
    
} catch(e) {
    pluginResponse.put("error", e.getMessage());
    pluginResponse.put("isSuccessful", false);
    error "[VibePlanner] Error: " + e.getMessage();
    
    // Return fallback on error
    pluginResponse = generateFallbackPlan("relaxed", "solo");
}

return pluginResponse;

// ===== PRIVACY-PRESERVING MOOD TAGGING =====
// Converts free-text mood to predefined safe tags
function tagMood(moodText) {
    text = moodText.toLowerCase();
    
    // Stressed/Tired -> relaxation needed
    if(text.contains("stress") || text.contains("tired") || text.contains("exhaust") || text.contains("overwhelm")) {
        return "needs_relaxation";
    }
    
    // Happy/Excited -> adventure
    if(text.contains("happy") || text.contains("excit") || text.contains("great") || text.contains("amazing")) {
        return "ready_for_adventure";
    }
    
    // Sad/Down -> comfort needed
    if(text.contains("sad") || text.contains("down") || text.contains("lonely") || text.contains("upset")) {
        return "needs_comfort";
    }
    
    // Bored -> excitement needed
    if(text.contains("bored") || text.contains("nothing") || text.contains("stuck")) {
        return "needs_excitement";
    }
    
    // Romantic mood
    if(text.contains("romantic") || text.contains("love") || text.contains("date")) {
        return "romantic_mood";
    }
    
    // Social mood
    if(text.contains("social") || text.contains("party") || text.contains("friends") || text.contains("fun")) {
        return "social_mood";
    }
    
    // Default: balanced
    return "balanced";
}

// ===== BUILD AI PROMPT =====
function buildAIPrompt(moodTag, company, duration) {
    prompt = "Create a personalized entertainment night plan.\n";
    prompt = prompt + "Mood: " + moodTag + "\n";
    prompt = prompt + "Company: " + (company.isEmpty() ? "solo" : company) + "\n";
    prompt = prompt + "Duration: " + (duration.isEmpty() ? "medium" : duration) + "\n\n";
    prompt = prompt + "Respond with ONLY this JSON structure (no markdown, no explanation):\n";
    prompt = prompt + "{\n";
    prompt = prompt + "  \"plan_type\": \"<type of evening>\",\n";
    prompt = prompt + "  \"movie\": {\"title\": \"<movie name>\", \"genre\": \"<genre>\", \"why\": \"<why this fits>\"},\n";
    prompt = prompt + "  \"food\": {\"cuisine\": \"<type>\", \"dish\": \"<specific dish>\", \"why\": \"<why this fits>\"},\n";
    prompt = prompt + "  \"activity\": {\"name\": \"<activity>\", \"why\": \"<why this fits>\"},\n";
    prompt = prompt + "  \"reason\": \"<overall reason for this plan>\",\n";
    prompt = prompt + "  \"timeline\": \"<suggested schedule>\"\n";
    prompt = prompt + "}";
    
    return prompt;
}

// ===== FALLBACK PLAN GENERATOR =====
function generateFallbackPlan(moodTag, company) {
    response = map();
    response.put("isSuccessful", true);
    
    fallbackPlans = map();
    
    // Relaxation plan
    relaxPlan = map();
    relaxPlan.put("plan_type", "Cozy Relaxation Night");
    relaxPlan.put("movie", {"title": "Studio Ghibli Film", "genre": "Animation", "why": "Gentle, calming visuals"});
    relaxPlan.put("food", {"cuisine": "Comfort Food", "dish": "Warm soup or pasta", "why": "Soothing and satisfying"});
    relaxPlan.put("activity", {"name": "Light stretching or meditation", "why": "Helps unwind"});
    relaxPlan.put("reason", "You need to decompress and recharge");
    relaxPlan.put("timeline", "Start with food -> Movie -> Wind down");
    fallbackPlans.put("needs_relaxation", relaxPlan);
    
    // Adventure plan
    adventurePlan = map();
    adventurePlan.put("plan_type", "Exciting Adventure Night");
    adventurePlan.put("movie", {"title": "Action Thriller", "genre": "Action", "why": "Matches your energy"});
    adventurePlan.put("food", {"cuisine": "Street Food", "dish": "Tacos or pizza", "why": "Fun and shareable"});
    adventurePlan.put("activity", {"name": "Bowling or arcade games", "why": "Channel that excitement"});
    adventurePlan.put("reason", "You're ready to make memories!");
    adventurePlan.put("timeline", "Activity first -> Dinner -> Movie");
    fallbackPlans.put("ready_for_adventure", adventurePlan);
    
    // Get matching plan or default
    selectedPlan = fallbackPlans.get(moodTag);
    if(selectedPlan == null) {
        selectedPlan = relaxPlan; // Default fallback
    }
    
    selectedPlan.put("privacy_note", "Generated locally - no external data shared.");
    selectedPlan.put("mood_tag_used", moodTag);
    
    response.put("vibe_plan", selectedPlan);
    response.put("message", "Here's a curated plan based on your vibe!");
    
    return response;
}
